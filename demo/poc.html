<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI DOM Modifier Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        #simulated-dom {
            border: 2px solid #3b82f6;
            min-height: 200px;
            padding: 1rem;
            background-color: white;
            transition: all 0.3s ease;
        }
        /* Custom scrollbar for the code output */
        .code-container {
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">LLM-Powered DOM Modifier</h1>
            <p class="text-gray-500 mt-1">Simulating a browser extension that uses Gemini to write and execute live JavaScript.</p>
        </header>

        <!-- Command Input -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
            <label for="command-input" class="block text-sm font-medium text-indigo-700 mb-2">Your Natural Language Command:</label>
            <textarea id="command-input" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="e.g., Change all H1 tags to H2 tags and make all paragraph text green.">Change all H1 tags to H2 tags and set the background color of the first list item to yellow.</textarea>
            <button id="execute-button" onclick="handleExecution()"
                class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-indigo-300">
                Generate & Execute Code
            </button>
            <div id="loading-indicator" class="mt-4 hidden text-center text-indigo-600 font-medium">
                Generating code with Gemini...
            </div>
        </div>

        <!-- Simulated DOM Area -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Simulated Webpage DOM (Content Editable)</h2>
            <div id="simulated-dom" contenteditable="true" class="rounded-lg ring-2 ring-indigo-300">
                <h1 class="text-2xl font-bold mb-2">Welcome to the Demo Page</h1>
                <p class="text-gray-700 mb-4">This paragraph text is for testing purposes.</p>
                <ul class="list-disc list-inside space-y-1">
                    <li class="font-medium">First list item (Target)</li>
                    <li>Second list item</li>
                    <li>Third list item</li>
                </ul>
                <div class="mt-4 p-3 bg-gray-100 rounded-md">
                    <span class="text-sm text-gray-600">Edit this content freely!</span>
                </div>
            </div>
        </div>

        <!-- Output and Status -->
        <div class="space-y-4">
            <div class="bg-white p-4 rounded-xl shadow border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Execution Status</h3>
                <p id="status-message" class="text-sm text-gray-600">Awaiting command...</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl shadow-inner">
                <h3 class="text-lg font-semibold text-green-400 mb-2">Generated JavaScript Code</h3>
                <pre class="code-container p-2 text-xs bg-gray-900 text-white rounded-lg"><code id="generated-code">// Code generated by the LLM will appear here.</code></pre>
            </div>
        </div>

    </div>

    <script>
        // Global variables for Firebase access (required by the environment)
        const apiKey = ""; // API key is handled by the canvas runtime environment
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const domElement = document.getElementById('simulated-dom');
        const statusMessage = document.getElementById('status-message');
        const generatedCodeElement = document.getElementById('generated-code');
        const loadingIndicator = document.getElementById('loading-indicator');
        const executeButton = document.getElementById('execute-button');

        /**
         * System instruction defining the LLM's role and constraints.
         * Crucially tells the model to target the specific element ID 'simulated-dom'.
         */
        const systemPrompt = `
            You are an expert JavaScript engineer specializing in DOM manipulation.
            Your task is to generate valid, executable JavaScript code that modifies the HTML DOM based on the user's instruction.
            You MUST wrap your output in a JSON object according to the provided schema.
            The code you generate will be executed against a target element with the ID 'simulated-dom'.
            Always start your manipulations by getting the root element: 'const root = document.getElementById("simulated-dom");'.
            DO NOT use global 'document' queries (like document.querySelectorAll) unless absolutely necessary, and prefer to query off the 'root' element.
            DO NOT include comments or console logs in the output code. The code must be production-ready and concise.
        `;

        /**
         * Defines the JSON structure the LLM must return.
         * This ensures we reliably extract the executable JS string.
         */
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "js_code": {
                    "type": "STRING",
                    "description": "The complete, executable JavaScript code block required to perform the DOM modification."
                }
            },
            propertyOrdering: ["js_code"]
        };

        /**
         * Executes a given string of JavaScript code safely within a try/catch block.
         * @param {string} code The JS code string to execute.
         */
        function executeCode(code) {
            try {
                // IMPORTANT: In a real Chrome extension, this code would be injected via
                // chrome.tabs.executeScript(). Here, we use eval for simulation.
                eval(code);
                statusMessage.textContent = `SUCCESS: Code executed successfully. DOM updated.`;
                domElement.style.borderColor = '#10b981'; // Tailwind green-500
                setTimeout(() => domElement.style.borderColor = '#3b82f6', 1500); // Reset color
            } catch (error) {
                statusMessage.textContent = `ERROR: Failed to execute generated code. ${error.message}`;
                domElement.style.borderColor = '#ef4444'; // Tailwind red-500
                console.error("Execution Error:", error);
            }
        }

        /**
         * Main function to handle the entire process:
         * 1. Get user command.
         * 2. Call Gemini API to generate JS code.
         * 3. Execute the generated JS code.
         */
        async function handleExecution() {
            const userCommand = document.getElementById('command-input').value.trim();

            if (!userCommand) {
                statusMessage.textContent = "Please enter a command.";
                return;
            }

            // UI State: Loading
            executeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            statusMessage.textContent = "Generating JavaScript code...";
            generatedCodeElement.textContent = `// Waiting for response...`;

            // Prepare the prompt for the model
            const userQuery = `Generate JavaScript code to modify the DOM of the target element based on this instruction: "${userCommand}".`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            let response = null;
            let attempts = 0;
            const maxAttempts = 3;

            // --- Exponential Backoff for API Call ---
            while (attempts < maxAttempts) {
                attempts++;
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success! Exit the loop.
                    }

                    // Handle rate limiting (429) or other retryable errors
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, attempts) * 1000;
                        console.warn(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    // For non-retryable errors, throw
                    throw new Error(`API returned status ${response.status}: ${response.statusText}`);

                } catch (error) {
                    if (attempts === maxAttempts) {
                        throw error; // Re-throw if maximum attempts reached
                    }
                }
            }
            // --- End Exponential Backoff ---

            // Process the response
            try {
                if (!response) {
                    throw new Error("API call failed after all retries.");
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("LLM response was empty or malformed.");
                }

                const parsedJson = JSON.parse(jsonText);
                const generatedCode = parsedJson.js_code;

                if (!generatedCode) {
                    throw new Error("Could not find 'js_code' in the structured response.");
                }

                // UI State: Code Received
                generatedCodeElement.textContent = generatedCode;
                statusMessage.textContent = "Code generated successfully. Executing now...";

                // Execute the generated code
                executeCode(generatedCode);

            } catch (e) {
                statusMessage.textContent = `FATAL ERROR: Failed to process LLM response or parse JSON. Check console for details.`;
                generatedCodeElement.textContent = `ERROR: ${e.message}`;
                domElement.style.borderColor = '#ef4444'; // Red error border
                console.error("Full Execution Error:", e);
            } finally {
                // UI State: Complete
                executeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
